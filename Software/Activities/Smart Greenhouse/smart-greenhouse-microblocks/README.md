## Microblocks




##### You can access the Microblocks code of the project by dragging the image to the Microblocks Run tab or clicking [here](https://microblocks.fun/run/microblocks.html#scripts=GP%20Scripts%0Adepends%20%27PicoBricks%27%0A%0Aspec%20%27%20%27%20%27ESP01_IP_address%27%20%27ESP01_IP_address%27%0Ato%20ESP01_IP_address%20%7B%0A%20%20comment%20%27AT%2BCIPSTA%3F%0A%0A%2BCIPSTA%3Aip%3A%22192.168.1.35%22%0A%2BCIPSTA%3Agateway%3A%22192.168.1.1%22%0A%2BCIPSTA%3Anetmask%3A%22255.255.255.0%22%0A%0AOK%27%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20comment%20%27Obtain%20the%20local%20IP%20address%20and%20MAC%20address%27%0A%20%20ESP01_current_cmd%20%3D%20%27CIPSTA%27%0A%20%20%27_sendATcmd%27%20%27AT%2BCIPSTA%3F%27%0A%20%20waitUntil%20ESP01_response%0A%20%20if%20%28%27ERROR%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27Get%20IP%3A%20%27%20ESP01_prev_status%29%0A%20%20%20%20sayIt%20%27ERROR%20while%20getting%20IP%20address.%27%0A%20%20%20%20waitMillis%20_espDisplayDelay%0A%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20stopTask%0A%20%20%7D%20else%20%7B%0A%20%20%20%20local%20%27searchIdx%27%20%28%27%5Bdata%3Afind%5D%27%20%27%2BCIPSTA%3Aip%3A%22%27%20savebuffer%29%0A%20%20%20%20if%20%28searchIdx%20%3E%200%29%20%7B%0A%20%20%20%20%20%20ESP01_IPaddr%20%3D%20%28%27%5Bdata%3AcopyFromTo%5D%27%20savebuffer%20%28searchIdx%20%2B%2012%29%20%28%28%27%5Bdata%3Afind%5D%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27%22%27%20_eol%29%20savebuffer%29%20-%201%29%29%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%27ESP01_log%20_%27%20%27GET%20IP%3A%20bad%20buffer%20content%27%0A%20%20%20%20%20%20sayIt%20%27Bad%20buffer%20content%20while%20getting%20IP%27%0A%20%20%20%20%20%20waitMillis%20_espDisplayDelay%0A%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20stopTask%0A%20%20%20%20%7D%0A%20%20%20%20if%20%28or%20%280%20%3D%3D%20%28size%20ESP01_IPaddr%29%29%20%28or%20%28ESP01_IPaddr%20%3D%3D%20%270.0.0.0%27%29%20%28ESP01_IPaddr%20%3D%3D%200%29%29%29%20%7B%0A%20%20%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27CONNECT%20to%20WIFI%3A%20%27%20%27no%20IP%20acquired%27%29%0A%20%20%20%20%20%20sayIt%20%27IP%20Address%20not%20acquired.%27%0A%20%20%20%20%20%20waitMillis%20_espDisplayDelay%0A%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20stopTask%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%20%27%20-%20%27%20ESP01_IPaddr%29%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_connect_to%27%20%27ESP01_connect_to%20_%20Password%20_%27%20%27auto%20auto%27%20%27Network_Name%27%20%27Network_Password%27%0Ato%20ESP01_connect_to%20ssid%20password%20%7B%0A%20%20comment%20%27AT%2BCWJAP%3D%22ssid%22%2C%22passwd%22%0AWIFI%20DISCONNECT%20%28If%20already%20connected%29%0AWIFI%20CONNECTED%0AWIFI%20GOT%20IP%0AOK%0A%0AOn%20FAIL%3A%0AAT%2BCWJAP%3D%22ssid%22%2C%22passwd%22%0AWIFI%20DISCONNECT%0A%2BCWJAP%3A2%20%28fail%20codes%201%20-%205%29%0AFAIL%0A%0AFAIL%20CODES%3A%0A1%3A%20connection%20timeout.%0A2%3A%20wrong%20password.%0A3%3A%20cannot%20find%20the%20target%20AP.%0A4%3A%20connection%20failed.%0Aothers%3A%20unknown%20error%20occurred.%0A%0ANOTE%3A%20CWJAP%20timeout%20is%2015%20secs.%27%0A%20%20ESP01_ssid%20%3D%20ssid%0A%20%20ESP01_password%20%3D%20password%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20comment%20%27Connect%20to%20an%20AP%20and%20get%20an%20IP%20address%27%0A%20%20ESP01_current_cmd%20%3D%20%27CWJAP%27%0A%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCWJAP%3D%22%27%20ssid%20%27%22%2C%22%27%20password%20%27%22%27%29%0A%20%20waitUntil%20ESP01_response%0A%20%20if%20%28%27FAIL%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20local%20%27failCode%27%20%28%27%5Bdata%3Afind%5D%27%20%27%2BCWJAP%3A%27%20savebuffer%29%0A%20%20%20%20failCode%20%3D%20%28%27%5Bdata%3AcopyFromTo%5D%27%20savebuffer%20%28failCode%20%2B%207%29%20%28%27%5Bdata%3Afind%5D%27%20_eol%20savebuffer%20failCode%29%29%0A%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%20%27%20code%20-%20%27%20failCode%29%0A%20%20%20%20sayIt%20%27WIFI%20Login%20Error.%27%0A%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20stopAll%0A%20%20%20%20stopTask%0A%20%20%7D%20else%20%7B%0A%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%29%0A%20%20%7D%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27r%27%20%27ESP01_display_LOG%27%20%27ESP01_display_LOG%27%0Ato%20ESP01_display_LOG%20%7B%0A%20%20if%20%280%20%3D%3D%20%28size%20ESP01_Log%29%29%20%7B%0A%20%20%20%20return%20%27LOG%20file%20is%20empty.%27%0A%20%20%7D%20else%20%7B%0A%20%20%20%20return%20%28%27%5Bdata%3AjoinStrings%5D%27%20ESP01_Log%20_eol%29%0A%20%20%7D%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_log%20_%27%20%27ESP01_log%20_%27%20%27str%27%20%27op%20result%27%0Ato%20%27ESP01_log%20_%27%20entry%20%7B%0A%20%20if%20debug%20%7B%0A%20%20%20%20%27%5Bdata%3AaddLast%5D%27%20entry%20ESP01_Log%0A%20%20%20%20if%20%28%28size%20ESP01_Log%29%20%3E%20ESP01_LogSize%29%20%7B%0A%20%20%20%20%20%20%27%5Bdata%3Adelete%5D%27%201%20ESP01_Log%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Aspec%20%27r%27%20%27ESP01_path_of_request%27%20%27ESP01_path_of_request%20_%27%20%27auto%27%20%27%27%0Ato%20ESP01_path_of_request%20request%20%7B%0A%20%20return%20%28%27_byteArray2string%27%20%28%27%5Bdata%3AcopyFromTo%5D%27%20request%20%28%28%27%5Bdata%3Afind%5D%27%20%27GET%20%27%20request%29%20%2B%204%29%20%28%28%27%5Bdata%3Afind%5D%27%20%27%20HTTP%27%20request%29%20-%201%29%29%29%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_requests%27%20%27ESP01_requests%27%0Ato%20ESP01_requests%20%7B%0A%20%20comment%20%27VERIFY%20TIMINGS%20IN%20THIS%20FUNCTION%0A%0AIF%20POSSIBLE%2C%20USE%20SEND%20ATCM%20FUNCTION%20WITH%20RETURN%20CHECK%0A%0ANEW%3A%20use%20TCPDATA%20as%20command%20to%20send%20out%20multiple%20TCP%20%20buffers%20with%20SEND%20OK%0Areturns.%27%0A%20%20waitUntil%20ESP01_server_ready%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20ESP01_current_cmd%20%3D%20%27TCPREQUEST%27%0A%20%20local%20%27req%27%20%28at%201%20ESP01_tcp_req_queue%29%0A%20%20local%20%27ptr%27%20%28%28%27%5Bdata%3Afind%5D%27%20%27%2BIPD%2C%27%20req%29%20%2B%205%29%0A%20%20_linkID%20%3D%20%28%27%5Bdata%3AcopyFromTo%5D%27%20req%20ptr%20%28%28%27%5Bdata%3Afind%5D%27%20_comma%20req%20ptr%29%20-%201%29%29%0A%20%20_reqPath%20%3D%20%28ESP01_path_of_request%20req%29%0A%20%20%27_handleIPD%27%0A%20%20ESP01_current_cmd%20%3D%20%27TCPREQUEST%27%0A%20%20comment%20%27CONFIRM%20good%20process%20b4%20DELETE%27%0A%20%20%27%5Bdata%3Adelete%5D%27%201%20ESP01_tcp_req_queue%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_restore%27%20%27ESP01_restore%27%0Ato%20ESP01_restore%20%7B%0A%20%20comment%20%27WIFI%20disconnects%2C%20IP%3A0.0.0.0%0AUART%3A115200%2C8%2C1%2C0%2C0%0ACWMODE%3A2%2C%20CWJAP%3AnoAP%2C%20CIPMUX%3A0%0ACIPSTO%3A180%2C%20%27%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20comment%20%27Restores%20the%20factory%20default%20settings%20of%20the%20module%27%0A%20%20ESP01_current_cmd%20%3D%20%27RESTORE%27%0A%20%20%27_sendATcmd%27%20%27AT%2BRESTORE%27%0A%20%20waitUntil%20ESP01_response%0A%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%29%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_server%27%20%27ESP01_server%20_%27%20%27str.ServerMenu%27%20%27Create%20Server%27%0Ato%20ESP01_server%20action%20%7B%0A%20%20comment%20%27Delete%2Fcreate%20a%20TCP%2FSSL%20server%0Aaction%3A%0A%E2%80%93%200%3A%20delete%20a%20server.%0A%E2%80%93%201%3A%20create%20a%20server.%0Aparam%3A%0A%E2%80%93%201%3A%20shutdown%20the%20server%20and%20close%20all%20connections.%0A-80%3A%20port%20number%20for%20create%20server%0A%0AOn%20repeated%20create%2C%20OK%20with%20%22no%20change%22%20received.%0A%27%0A%20%20if%20%28%27Delete%20Server%27%20%3D%3D%20action%29%20%7B%0A%20%20%20%20local%20%27actionMode%27%200%0A%20%20%20%20local%20%27param%27%201%0A%20%20%7D%20%28%27Create%20Server%27%20%3D%3D%20action%29%20%7B%0A%20%20%20%20local%20%27actionMode%27%201%0A%20%20%20%20local%20%27param%27%2080%0A%20%20%7D%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20ESP01_current_cmd%20%3D%20%27CIPSERVER%27%0A%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCIPSERVER%3D%27%20actionMode%20%27%2C%27%20param%29%0A%20%20waitUntil%20ESP01_response%0A%20%20if%20%28%27OK%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20ESP01_server_ready%20%3D%20%28booleanConstant%20true%29%0A%20%20%7D%20else%20%7B%0A%20%20%20%20ESP01_server_ready%20%3D%20%28booleanConstant%20false%29%0A%20%20%7D%0A%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20actionMode%20%27%20-%20%27%20ESP01_prev_status%29%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_set_MUX%27%20%27ESP01_set_MUX%20_%27%20%27str.MuxMenu%27%20%27Multiple%20Connections%27%0Ato%20ESP01_set_MUX%20mux%20%7B%0A%20%20if%20%28%27Single%20Connection%27%20%3D%3D%20mux%29%20%7B%0A%20%20%20%20local%20%27muxMode%27%200%0A%20%20%7D%20%28%27Multiple%20Connections%27%20%3D%3D%20mux%29%20%7B%0A%20%20%20%20local%20%27muxMode%27%201%0A%20%20%7D%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20ESP01_current_cmd%20%3D%20%27CIPMUX%27%0A%20%20comment%20%27Enable%2Fdisable%20the%20multiple%20connections%20mode%27%0A%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCIPMUX%3D%27%20muxMode%29%0A%20%20waitUntil%20ESP01_response%0A%20%20if%20%28%27ERROR%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20muxMode%20%27%20-%20%27%20ESP01_prev_status%29%0A%20%20%20%20sayIt%20%27ERROR%20during%20MUX%20set.%27%0A%20%20%20%20waitMillis%20_espDisplayDelay%0A%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20stopTask%0A%20%20%7D%0A%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20muxMode%20%27%20-%20%27%20ESP01_prev_status%29%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27%20%27%20%27ESP01_set_WIFI_mode%27%20%27ESP01_set_WIFI_mode%20_%27%20%27str.ModeMenu%27%20%27Station%27%0Ato%20ESP01_set_WIFI_mode%20mode%20%7B%0A%20%20comment%20%27AT%2BCWMODE%3D1%0AOK%27%0A%20%20if%20%28%27Station%27%20%3D%3D%20mode%29%20%7B%0A%20%20%20%20local%20%27modeIn%27%201%0A%20%20%7D%20%28%27SoftAP%27%20%3D%3D%20mode%29%20%7B%0A%20%20%20%20local%20%27modeIn%27%202%0A%20%20%7D%20%28%27Station%26SoftAP%27%20%3D%3D%20mode%29%20%7B%0A%20%20%20%20local%20%27modeIn%27%203%0A%20%20%7D%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20comment%20%27Set%20the%20Wi-Fi%20mode%20%28Station%2FSoftAP%2FStation%2BSoftAP%29%27%0A%20%20ESP01_current_cmd%20%3D%20%27CWMODE%27%0A%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCWMODE%3D%27%20modeIn%29%0A%20%20waitUntil%20ESP01_response%0A%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27WIFI%20Mode%20%27%20mode%20_colon%20ESP01_prev_status%29%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%7D%0A%0Aspec%20%27r%27%20%27_byteArray2string%27%20%27_byteArray2string%20_%27%20%27auto%27%20%27%27%0Ato%20%27_byteArray2string%27%20aStringOrByteArray%20%7B%0A%20%20comment%20%27If%20argument%20is%20a%20byte%20array%2C%20convert%20it%20to%20a%20string.%20%27%0A%20%20if%20%28not%20%28isType%20aStringOrByteArray%20%27string%27%29%29%20%7B%0A%20%20%20%20aStringOrByteArray%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20%27%27%20aStringOrByteArray%29%0A%20%20%7D%0A%20%20return%20aStringOrByteArray%0A%7D%0A%0Aspec%20%27r%27%20%27_cmdError%27%20%27_cmdError%27%0Ato%20%27_cmdError%27%20%7B%0A%20%20local%20%27cmdIndx%27%20%28%27%5Bdata%3Afind%5D%27%20ESP01_current_cmd%20ATCommands%29%0A%20%20comment%20%27need%20STRING%20compare%27%0A%20%20if%20%28%270%27%20%3D%3D%20%28at%20%28cmdIndx%20%2B%202%29%20ATCommands%29%29%20%7B%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%0A%20%20local%20%27target%27%20%28at%20%28at%20%28cmdIndx%20%2B%202%29%20ATCommands%29%20ATResponses%29%0A%20%20_serFindIndex%20%3D%20%28%27%5Bdata%3Afind%5D%27%20target%20_serbuffer%29%0A%20%20if%20%28-1%20%3D%3D%20_serFindIndex%29%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20%27%3Cerror%3E%20not%20found.%27%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%20else%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20target%0A%20%20%20%20savebuffer%20%3D%20%28%27_byteArray2string%27%20%28%27%5Bdata%3AcopyFromTo%5D%27%20_serbuffer%201%20%28%28_serFindIndex%20%2B%20%28size%20target%29%29%20%2B%202%29%29%29%0A%20%20%20%20return%20%28booleanConstant%20true%29%0A%20%20%7D%0A%7D%0A%0Aspec%20%27r%27%20%27_cmdGood%27%20%27_cmdGood%27%0Ato%20%27_cmdGood%27%20%7B%0A%20%20if%20%28%27TCPREQUEST%27%20%3D%3D%20ESP01_current_cmd%29%20%7Breturn%20%28booleanConstant%20false%29%7D%0A%20%20local%20%27cmdIndx%27%20%28%27%5Bdata%3Afind%5D%27%20ESP01_current_cmd%20ATCommands%29%0A%20%20local%20%27target%27%20%28at%20%28at%20%28cmdIndx%20%2B%201%29%20ATCommands%29%20ATResponses%29%0A%20%20_serFindIndex%20%3D%20%28%27%5Bdata%3Afind%5D%27%20target%20_serbuffer%29%0A%20%20if%20%28-1%20%3D%3D%20_serFindIndex%29%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20%27%3Cgood%3E%20not%20found.%27%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%20else%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20target%0A%20%20%20%20if%20%28%27RESTORE%27%20%3D%3D%20ESP01_current_cmd%29%20%7B%0A%20%20%20%20%20%20savebuffer%20%3D%20%28%27_byteArray2string%27%20%28%27%5Bdata%3Ajoin%5D%27%20%28%27%5Bdata%3AcopyFromTo%5D%27%20_serbuffer%201%20%28%28%27%5Bdata%3Afind%5D%27%20%27OK%27%20_serbuffer%29%20%2B%204%29%29%20%28%27%5Bdata%3AcopyFromTo%5D%27%20_serbuffer%20_serFindIndex%29%29%29%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20savebuffer%20%3D%20%28%27_byteArray2string%27%20%28%27%5Bdata%3AcopyFromTo%5D%27%20_serbuffer%201%20%28%28_serFindIndex%20%2B%20%28size%20target%29%29%20%2B%202%29%29%29%0A%20%20%20%20%7D%0A%20%20%20%20return%20%28booleanConstant%20true%29%0A%20%20%7D%0A%7D%0A%0Aspec%20%27%20%27%20%27_handleIPD%27%20%27_handleIPD%27%0Ato%20%27_handleIPD%27%20%7B%0A%20%20atPut%202%20responses%20%28%27%5Bdata%3AmakeList%5D%27%20%27%2FSERA%27%20%28%27%5Bdata%3Ajoin%5D%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27HTTP%2F1.1%20200%20OK%27%20_eol%20%27Content-Type%3A%20text%2Fhtml%27%20_eol%20_eol%29%20%27%7B%22TEMP%22%3A%27%20%28pb_temperature%29%20%27%2C%22S.Moisture%22%3A%27%20%28%28%28analogReadOp%2027%29%20%2A%20100%29%20%2F%201023%29%20%27%2C%22Humidity%22%3A%27%20%28pb_humidity%29%20%27%7D%27%29%29%0A%20%20for%20response%20responses%20%7B%0A%20%20%20%20if%20%28_reqPath%20%3D%3D%20%28at%201%20response%29%29%20%7B%0A%20%20%20%20%20%20processRequest%0A%20%20%20%20%20%20comment%20%27Following%20is%20a%20TCP%20messaging%20sequence%20to%20send%20back%20any%20feedback%20desired.%27%0A%20%20%20%20%20%20ESP01_current_cmd%20%3D%20%27CIPSEND%27%0A%20%20%20%20%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCIPSEND%3D%27%20_linkID%20_comma%20%28size%20%28at%202%20response%29%29%29%0A%20%20%20%20%20%20waitUntil%20ESP01_response%0A%20%20%20%20%20%20if%20%28TCPprompt%20%21%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20%20%20%20%20%27ESP01_log%20_%27%20%27No%20TCP%20prompt%20received.%27%0A%20%20%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20comment%20%27TCP%20Prompt%27%0A%20%20%20%20%20%20ESP01_current_cmd%20%3D%20%27TCPDATA%27%0A%20%20%20%20%20%20%27_sendATcmd%27%20%28at%202%20response%29%0A%20%20%20%20%20%20waitUntil%20ESP01_response%0A%20%20%20%20%20%20if%20%28%27SEND%20FAIL%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%29%0A%20%20%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20comment%20%27Good%20SEND%27%0A%20%20%20%20%20%20ESP01_current_cmd%20%3D%20%27CIPCLOSE%27%0A%20%20%20%20%20%20%27_sendATcmd%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27AT%2BCIPCLOSE%3D%27%20_linkID%29%0A%20%20%20%20%20%20waitUntil%20ESP01_response%0A%20%20%20%20%20%20if%20%28%27ERROR%27%20%3D%3D%20ESP01_prev_status%29%20%7B%0A%20%20%20%20%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20ESP01_prev_status%29%0A%20%20%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20cmdComplete%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20%20%20comment%20%27Good%20CLOSE%27%0A%20%20%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27TCPREQUEST%27%20_colon%20_reqPath%20%27%20processed.%27%29%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Aspec%20%27%20%27%20%27_logging%20_%27%20%27_logging%20_%27%20%27bool%27%20true%0Ato%20%27_logging%20_%27%20mode%20%7B%0A%20%20debug%20%3D%20mode%0A%7D%0A%0Aspec%20%27r%27%20%27_queueRequest%27%20%27_queueRequest%20_%27%20%27str%27%20%27text%27%0Ato%20%27_queueRequest%27%20req%20%7B%0A%20%20comment%20%27TCP%20Request%20Queue%0AThis%20will%20hold%20up%20to%205%20requests%20sent%20from%0Abrowsers%20or%20cell%20phones.%0ARequests%20are%20differentiated%20by%20their%20LINK-ID.%27%0A%20%20if%20%28%28size%20ESP01_tcp_req_queue%29%20%3C%205%29%20%7B%0A%20%20%20%20%27%5Bdata%3AaddLast%5D%27%20req%20ESP01_tcp_req_queue%0A%20%20%20%20%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20ESP01_current_cmd%20_colon%20req%29%0A%20%20%20%20return%20%27OK%27%0A%20%20%7D%20else%20%7B%0A%20%20%20%20comment%20%27This%20might%20require%20an%20out-of-band%20ERROR%20reply%0Aregardless%20of%20queue%20status.%27%0A%20%20%20%20%27ESP01_log%20_%27%20%27TCP%20Request%20Queue%20Full.%27%0A%20%20%20%20return%20%27ERROR%27%0A%20%20%7D%0A%7D%0A%0Aspec%20%27%20%27%20%27_sendATcmd%27%20%27_sendATcmd%20_%27%20%27str%27%20%27ATcmd%27%0Ato%20%27_sendATcmd%27%20cmd%20%7B%0A%20%20comment%20%27Mandatory%201sec%20wait%20after%20each%20command.%0AAlso%2C%20TCPSend%20takes%2020ms%20to%20send%20out%20%0Athe%20buffer%20if%20it%20is%20shorter%20than%20stated%20length.%0AOne%20can%20also%20use%20the%20CIPSENDEX%20command%0Aand%20terminate%20strings%20with%20%5C0%20to%20eliminate%20length%0Amatching%20and%20calculating.%27%0A%20%20cmd%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20cmd%20_eol%29%0A%20%20%27%5Bserial%3Awrite%5D%27%20cmd%0A%20%20waitMillis%20_espCmdDelay%0A%7D%0A%0Aspec%20%27r%27%20%27_tcpRequest%27%20%27_tcpRequest%27%0Ato%20%27_tcpRequest%27%20%7B%0A%20%20comment%20%27PARTIAL%20TCP%20Request%3A%0A%0A0%2CCONNECT%0A%0A%2BIPD%2C0%2C444%3AGET%20%2F%20HTTP%2F1.1%0AHost%3A%20192.168.1.35%0AConnection%3A%20keep-alive%0A...%0A%0ARequests%20are%20differentiated%20by%20their%20LINK-ID.%0ALINK-ID%20is%20the%20number%20before%20CONNECT%2C%20and%20after%20%2BIPD%20in%20buffer.%0A%0ATCP%20requests%20are%20queued%20and%20therefore%20do%20not%20need%20the%20transaction%20lock%0AcmdComplete%20to%20be%20used.%20But%20we%20need%20to%20clear%20the%20_serBuffer.%27%0A%20%20if%20%28not%20ESP01_server_ready%29%20%7B%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%20%28%27TCPREQUEST%27%20%21%3D%20ESP01_current_cmd%29%20%7B%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%0A%20%20local%20%27cmdIndx%27%20%28%27%5Bdata%3Afind%5D%27%20ESP01_current_cmd%20ATCommands%29%0A%20%20local%20%27target%27%20%28at%20%28at%20%28cmdIndx%20%2B%201%29%20ATCommands%29%20ATResponses%29%0A%20%20_serFindIndex%20%3D%20%28%27%5Bdata%3Afind%5D%27%20target%20_serbuffer%29%0A%20%20if%20%28-1%20%3D%3D%20_serFindIndex%29%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20%27%3CtcpRequest%3E%20not%20found.%27%0A%20%20%20%20return%20%28booleanConstant%20false%29%0A%20%20%7D%20else%20%7B%0A%20%20%20%20ESP01_prev_status%20%3D%20target%0A%20%20%20%20local%20%27request%27%20%28%27%5Bdata%3AcopyFromTo%5D%27%20_serbuffer%20_serFindIndex%20%28%28%27%5Bdata%3Afind%5D%27%20%27Host%3A%20%27%20_serbuffer%29%20-%201%29%29%0A%20%20%20%20_serbuffer%20%3D%20%28%27%5Bdata%3AnewByteArray%5D%27%200%29%0A%20%20%20%20if%20%28%27OK%27%20%3D%3D%20%28%27_queueRequest%27%20request%29%29%20%7B%0A%20%20%20%20%20%20return%20%28booleanConstant%20true%29%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20return%20%28booleanConstant%20true%29%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Aspec%20%27%20%27%20%27initializeCommands%27%20%27initializeCommands%27%0Ato%20initializeCommands%20%7B%0A%20%20comment%20%27ESP%20Delays%3A%0A_espBufferDelay%3A%20time%20between%20serial%20reads%0A_espCmdDelay%3A%20time%20to%20wait%20after%20each%20command%0A_espLoopDelay%3A%20time%20between%20COMM%20Loop%20cycles%0A%0ANOTE%3A%0A-%20Do%20not%20reduce%20_espCmdDelay%20to%20less%20than%202000.%0A-%20Reducing%20_espLoopDelay%20is%20just%20churn%3B%20does%20not%20help%20speed%20things%20up.%27%0A%20%20comment%20%27Command%20%2F%20Response%20Pairs%3A%0AATCommands%0A-%20command%20name%2C%20good%20index%2C%20error%20index%0AATResponses%0A-%20List%20of%20good%20and%20error%20responses%20to%20the%20commands%0A%0AIf%20you%20insert%20into%20ATResponses%2C%20adjust%20all%20ATCommand%20indexes.%27%0A%20%20debug%20%3D%20%28booleanConstant%20true%29%0A%20%20_espBufferDelay%20%3D%20500%0A%20%20_espCmdDelay%20%3D%201000%0A%20%20_espLoopDelay%20%3D%20500%0A%20%20ESP01_Log%20%3D%20%28%27%5Bdata%3AmakeList%5D%27%29%0A%20%20ESP01_prev_status%20%3D%20%27%27%0A%20%20savebuffer%20%3D%20%27%27%0A%20%20TCPprompt%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20%27OK%27%20_eol%20%27%3E%27%20%28%27%5Bdata%3AunicodeString%5D%27%2032%29%29%0A%20%20ATCommands%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20%27RESTORE%2C6%2C0%27%20_comma%20%27RST%2C1%2C2%27%20_comma%20%27CWMODE%2C1%2C2%27%20_comma%20%27CWJAP%2C1%2C7%27%20_comma%20%27CIPSTA%2C1%2C2%27%20_comma%20%27CIPMUX%2C1%2C2%27%20_comma%20%27CIPSERVER%2C1%2C2%27%20_comma%20%27TCPREQUEST%2C8%2C9%27%20_comma%20%27CIPSEND%2C5%2C0%27%20_comma%20%27TCPDATA%2C3%2C4%27%20_comma%20%27CIPCLOSE%2C9%2C2%27%29%0A%20%20ATCommands%20%3D%20%28%27%5Bdata%3Asplit%5D%27%20ATCommands%20_comma%29%0A%20%20ATResponses%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20%27OK%27%20%27%2CERROR%27%20%27%2CSEND%20OK%27%20%27%2CSEND%20FAIL%2C%27%20TCPprompt%20%27%2Cready%27%20%27%2CFAIL%27%20%27%2C%2BIPD%27%20%27%2CCLOSED%27%29%0A%20%20ATResponses%20%3D%20%28%27%5Bdata%3Asplit%5D%27%20ATResponses%20_comma%29%0A%7D%0A%0Aspec%20%27%20%27%20%27initializeResponses%27%20%27initializeResponses%27%0Ato%20initializeResponses%20%7B%0A%20%20comment%20%27APP%20Inventor%20APP%20processes%202%20kinds%20of%20responses%20from%20this%20program%3A%0A1.%20Web%20Page%20displays%20of%20info%0A2.%20JSON%20data%20sent%20in%20response%20to%20HTTP%20GET%20%2FSERA%20%20and%20%2FWATERING%20transactions%20%0A%0A%231%20type%20responses%20are%20processed%20in%20the%20WebViewer%20component%20and%20%0Ado%20not%20require%20a%20header%20info.%0A%0A%232%20type%20responses%20are%20true%20responses%20to%20HTTP%20GET%20and%20require%20%0Aa%20proper%20header%3A%0A%20%20%20%20HTTP%2F1.1%20200%20OK%5CnContent-Type%3A%20text%2Fhtml%5Cn%5Cn%20is%20%0A%0ANOTE%3A%20timeout%20delay%20for%20the%20HTTTP%20GET%20has%20to%20be%20long%20enough%20%0A%20%20%20%20%20%20%20%20%20%20%20%20to%20receive%20and%20process%20the%20data.%20Current%20setting%20is%2010000ms.%0A%20%20%20%20%20%20%20%20%20%20%20%20However%2C%20if%20more%20data%20is%20sent%20than%20the%20example%2C%20it%20might%20need%0A%20%20%20%20%20%20%20%20%20%20%20%20extending.%0A%0AThe%20browsers%20do%20an%20auto%20%22favicon.ico%22%20request%20after%20TCPclose%2C%20which%20causes%20another%0Aincoming%20request.%20To%20prevent%20it%2C%20browser%20requests%20are%20preceeded%20by%20a%20TCPSend%20of%20the%0A%2Ffavicon%20item%20of%20responses%20as%20part%20of%20the%20HTML%20head.%27%0A%20%20responses%20%3D%20%28%27%5Bdata%3AmakeList%5D%27%20%28%27%5Bdata%3AmakeList%5D%27%20%27%2F%27%20%27%3CH1%3ECONNECTED...%3Cbr%2F%3E%3C%2FH1%3E%0A%3Cp%3E%2FSERA%3A%20Temp%2C%20Humidity%2C%20Soil%20Moisture%3Cbr%2F%3E%0A%2FWATERING%3A%20Run%20Water%20Pump%3Cbr%2F%3E%0A%3C%2Fp%3E%27%29%20%28%27%5Bdata%3AmakeList%5D%27%20%27%2FSERA%27%20%28%27%5Bdata%3Ajoin%5D%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27HTTP%2F1.1%20200%20OK%27%20_eol%20%27Content-Type%3A%20text%2Fhtml%27%20_eol%20_eol%29%20%27%7B%22TEMP%22%3A%27%20temperature%20%27%2C%22S.Moisture%22%3A%27%20soilMoisture%20%27%2C%22Humidity%22%3A%27%20humidity%20%27%7D%27%29%29%20%28%27%5Bdata%3AmakeList%5D%27%20%27%2FWATERING%27%20%27%3CH1%3ESERA%20CONTROL%3Cbr%2F%3E%3C%2FH1%3E%0A%3Cp%3EIrrigation%20is%20complete..%3C%2Fp%3E%27%29%20%28%27%5Bdata%3AmakeList%5D%27%20%27%2Ffavicon%27%20%27%3CHEAD%3E%3Clink%20rel%3D%22icon%22%20href%3D%22data%3A%2C%22%3E%3C%2FHEAD%3E%27%29%29%0A%20%20%27ESP01_log%20_%27%20%27RESPONSES%20initialized.%27%0A%7D%0A%0Aspec%20%27%20%27%20%27processRequest%27%20%27processRequest%27%0Ato%20processRequest%20%7B%0A%20%20comment%20%27Here%20is%20where%20all%20the%20program%20actions%20are%20evaluated%20and%20implemented.%0AProvide%20processing%20code%20for%20each%20function%20with%20its%20specific%20evaluation.%0AIf%20the%20activity%20code%20is%20too%20long%20%2F%20large%2C%20then%20provide%20a%20call%20to%20a%20custom%20function.%27%0A%20%20if%20%28%28ESP01_path_of_request%20%28at%201%20ESP01_tcp_req_queue%29%29%20%3D%3D%20%27%2FWATERING%27%29%20%7B%0A%20%20%20%20pb_set_motor_speed%201%20100%0A%20%20%20%20%27ESP01_log%20_%27%20%27SERA%3A%20Water%20pump%20started%27%0A%20%20%20%20waitMillis%201000%0A%20%20%20%20pb_set_motor_speed%201%200%0A%20%20%20%20%27ESP01_log%20_%27%20%27SERA%3A%20Water%20pump%20stopped.%27%0A%20%20%7D%0A%7D%0A%0Ascript%201032%2077%20%7B%0AwhenCondition%20%28%28size%20ESP01_tcp_req_queue%29%20%3E%200%29%0AsayIt%20%28size%20ESP01_tcp_req_queue%29%0Aif%20ESP01_server_ready%20%7B%0A%20%20ESP01_requests%0A%7D%0AsayIt%20%28size%20ESP01_tcp_req_queue%29%0A%7D%0A%0Ascript%201035%20305%20%7B%0AwhenBroadcastReceived%20%27COMM%20Loop%27%0Aforever%20%7B%0A%20%20cmdComplete%20%3D%20%28booleanConstant%20false%29%0A%20%20ESP01_status%20%3D%20%27%27%0A%20%20ESP01_response%20%3D%20%28booleanConstant%20false%29%0A%20%20_serbuffer%20%3D%20%28%27%5Bdata%3AnewByteArray%5D%27%200%29%0A%20%20local%20%27readBuffer%27%20%28%27%5Bserial%3Aread%5D%27%29%0A%20%20if%20%28%28size%20readBuffer%29%20%3E%200%29%20%7B%0A%20%20%20%20repeatUntil%20%28and%20%280%20%3D%3D%20%28size%20readBuffer%29%29%20%28or%20%28or%20%28%27_cmdGood%27%29%20%28%27_cmdError%27%29%29%20%28%27_tcpRequest%27%29%29%29%20%7B%0A%20%20%20%20%20%20_serbuffer%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20_serbuffer%20readBuffer%29%0A%20%20%20%20%20%20waitMillis%20_espBufferDelay%0A%20%20%20%20%20%20readBuffer%20%3D%20%28%27%5Bserial%3Aread%5D%27%29%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20comment%20%27We%20have%20a%20buffer%20with%20IPD%20or%20good%20or%20error%20%27%0A%20%20if%20%28%28size%20_serbuffer%29%20%3E%200%29%20%7B%0A%20%20%20%20ESP01_response%20%3D%20%28booleanConstant%20true%29%0A%20%20%20%20waitUntil%20cmdComplete%0A%20%20%7D%0A%20%20waitMillis%20_espLoopDelay%0A%7D%0A%7D%0A%0Ascript%20531%20-127%20%7B%0AwhenStarted%0Alocal%20%27delay%27%2050%0Arepeat%209%20%7B%0A%20%20setUserLED%20true%0A%20%20waitMillis%20delay%0A%20%20setUserLED%20false%0A%20%20waitMillis%20delay%0A%7D%0A_eol%20%3D%20%28%27%5Bdata%3Ajoin%5D%27%20%28%27%5Bdata%3AunicodeString%5D%27%2013%29%20%28%27%5Bdata%3AunicodeString%5D%27%2010%29%29%0AESP01_tcp_req_queue%20%3D%20%28%27%5Bdata%3AmakeList%5D%27%29%0AESP01_LogSize%20%3D%2025%0AESP01_server_ready%20%3D%20%28booleanConstant%20false%29%0A_espDisplayDelay%20%3D%202000%0A_colon%20%3D%20%28%27%5Bdata%3AunicodeString%5D%27%2058%29%0A_comma%20%3D%20%28%27%5Bdata%3AunicodeString%5D%27%2044%29%0AESP01_IPaddr%20%3D%20%27%27%0AinitializeCommands%0AinitializeResponses%0A%27%5Bserial%3Aopen%5D%27%20115200%0AsendBroadcast%20%27COMM%20Loop%27%0AwaitMillis%20_espBufferDelay%0A%27_logging%20_%27%20true%0AsayIt%20%27Preparing%20SERVER%20setup.%0APlease%20wait%20till%20next%20prompt.%27%0Atimer%20%3D%20%28millisOp%29%0AESP01_restore%0AESP01_set_WIFI_mode%20%27Station%27%0AESP01_connect_to%20%27SSID%27%20%27PASSWORD%27%0AESP01_IP_address%0AESP01_set_MUX%20%27Multiple%20Connections%27%0AESP01_server%20%27Create%20Server%27%0Atimer%20%3D%20%28%28millisOp%29%20-%20timer%29%0A%27ESP01_log%20_%27%20%28%27%5Bdata%3Ajoin%5D%27%20%27Completed%20in%20%27%20timer%20%27ms%27%29%0AsayIt%20%27SERVER%20Ready%20for%20transactions.%27%20_eol%20%27Open%20a%20browser%20tab%20and%20%27%20_eol%20%27%20%20use%20IP%3A%27%20ESP01_IPaddr%20_eol%20%27Competed%20in%27%20timer%20%27%20msecs.%27%0AsendBroadcast%20%27COMM%20Loop%27%0AESP01_current_cmd%20%3D%20%27TCPREQUEST%27%0A%7D%0A%0Ascript%201031%20-131%20%7B%0AwhenBroadcastReceived%20%27COMM%20Loop%27%0Aif%20ESP01_server_ready%20%7B%0A%20%20sayIt%20%27COMM%20Loop%20running.%27%20_eol%20%27SERVER%20ready.%27%0A%20%20stopTask%0A%7D%20else%20%7B%0A%20%20sayIt%20%27COMM%20Loop%20started%27%20_eol%20%27SERVER%20not%20ready.%27%0A%7D%0A%7D%0A%0Ascript%20646%20-333%20%7B%0Acomment%20%27There%20are%20two%20cycles%3A%20command%20%26%20data.%0ACommand%3A%0A-%20current%20Cmd%20%3D%20%3Cone%20of%20the%20AT%20cmds%3E%0A-%20checks%20good%2Fbad%20responses%0A-%20cycle%20finishes%20with%20SERVER%20ON.%0A%0AData%3A%0A-%20current%20Cmd%20%3D%20TCPREQUEST.%0A-%20checks%20for%20%2BIPD%0A-%20any%20%2BIPD%20goes%20into%20Queu%2C%20%0A-%20When%20Q%20%3E%200%3A%0A%20%20%20%20%20If%20server%20ready%20process%20it%20%0A%0ASince%20OLED%20is%20not%20used%2C%20run%20once%20with%20cable%20attached%0Ato%20get%20the%20IP%20address%20of%20the%20Server.%20Then%20disconnect%20if%0Aneeded.%27%0A%7D%0A%0Ascript%20795%20-13%20%28ESP01_display_LOG%29%0A%0A "here").
